<!DOCTYPE HTML>
<html>
	<head>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<script src="jquery-1.11.3.min.js"></script>
		<script src="kcSHIPDATA.js"></script>
		<script src="kcEQDATA.js"></script>
		<script src="kcEDGES.js"></script>
		<script src="kcMAPDATA.js"></script>
		<script src="shared.js"></script>
		<script src="pixi.js"></script>
		<script src="howler.min.js"></script>
		<script type="text/javascript" src="reader/steganography.js"></script>
		<script type="text/javascript">
		function loadImage(file) {
			var preview = document.getElementById('imgpreview');
			var reader  = new FileReader();
			$('#error').text('Loading');

			preview.onload = function(){
				console.log(reader.result);
				try { 
					var msg = steganography.decode(reader.result);
					document.getElementById('code').value = msg;
				} catch(e) {
					$('#error').text('Error, data may be corrupted');
					return;
				}
				loadCode();
				//$('#error').text('');
			};

			reader.onloadend = function (e) {
				preview.src = reader.result;
			}
			
			if (file) {
				reader.readAsDataURL(file);
			} else {
				preview.src = "";
			}
		}
		function loadImgURL(url) {
			var preview = document.getElementById('imgpreview');
			var xhr = new XMLHttpRequest();
			xhr.responseType = 'blob';
			xhr.onload = function() {
				loadImage(xhr.response);
			}
			xhr.onerror = function(e) {
				$('#error').text('Invalid URL');
				console.log(e);
			}
			xhr.open('GET',url);
			xhr.send();
		}
		function parseURLParams(url) {
			var queryStart = url.indexOf("?") + 1;
			var queryEnd   = url.indexOf("#") + 1 || url.length + 1;
			var query = url.slice(queryStart, queryEnd - 1);
			var pairs = query.replace(/\+/g, " ").split("&");
			var parms = {};
			var i, n, v, nv;

			if (query === url || query === "") {
				return;
			}

			for (i = 0; i < pairs.length; i++) {
				nv = pairs[i].split("=");
				n = decodeURIComponent(nv[0]);
				v = decodeURIComponent(nv[1]);

				if (!parms.hasOwnProperty(n)) {
					parms[n] = [];
				}

				parms[n].push(nv.length === 2 ? v : null);
			}
			return parms;
		}
		function checkFormData() {
			if (location.toString().indexOf("?") <= 0) {
				return;
			}

			var params = parseURLParams(location.toString());

			if (params["url"] && params["url"][0]) {
				loadImgURL(params["url"][0]);
			}
		}
		</script>
		<style>
			.infotable {
				border-collapse: collapse;
				font-size: 14px;
			}
			.infotable td {
				border: 1px solid black;
				padding: 0px;
				width:50px;
				height:10px;
			}
			.infotable img {
				vertical-align: middle;
			}
		</style>
	</head>
	<body onload="checkFormData();">
		<span style="font-size:24px;font-weight:bold">KanColle Battle Replayer</span> <span style="color:red;margin-left:20px">v1.0 Beta 2.0 <span style="margin-left:20px;font-style:italic">(Last update: 2016-01-06)</span></span>
		<br><br>
		<div>
			<div>
				<div style="width:150px;float:left">
					
				</div>
				<div style="float:left;width:400px">
					<!--<input type="button" value="&lt; Back" onclick="clickedBack()" />-->
					<input type="button" value="Pause" onclick="if(started) {PAUSE=!PAUSE;$(this).css('background-color',(PAUSE)?'grey':'');}" />
					<!--<input type="button" value="Skip &gt;" onclick="clickedSkip()" />-->
					<input type="button" value="Restart" onclick="if(started)reset(function(){processAPI(API);})" />
					<input type="range" value="40" min="0" max="80" oninput="var num=parseInt(this.value);RATE=(num<40)?num/40:(num-40)/10+1;$('#speednum').text('x'+RATE)"/>
					<span id="speednum">x1</span>
				</div>
				<div style="float:left;width:300px">
					<span>Skip to Battle: </span>
					<span id="skipbuttonspace"></span>
				</div>
				<div style="float:left;width:200px">
					<input type="button" value="&#128266;" style="width:30px" onclick="if(!Howler._muted){Howler.mute();this.value='&#128263;'}else{Howler.unmute();this.value='&#128266;';Howler.volume(parseFloat($('#rngvol').val()))}" />
					<input id="rngvol" type="range" value=".6" step=".01" min="0" max="1" style="width:100px" oninput="if(!Howler._muted)Howler.volume(parseFloat(this.value))" />
				</div>
			</div>
			<div style="width:800px;height:100px;padding-top:20px;clear:both">
				<div style="float:left;width:240px">
					<!--Detection: <span id="plDet1"></span>--><br><br>
					Air Battle: <span id="plAS1" style="font-weight:bold;font-size:20px"></span><br><br>
					<canvas id="plHP1" width="240px" height="10px" style="border:1px solid black;border-radius:5px"></canvas>
				</div>
				<div style="float:left;width:320px;text-align:center">
					<br><br>
					Engagement:<br>
					<span id="plEngage" style="font-size:20px"></span> <span id="plEngageT" style="font-size:18px;font-weight:bold"></span>
				</div>
				<div style="float:right;width:240px;align:right">
					<br><br>
					Air Battle: <span id="plAS2" style="font-weight:bold;font-size:20px"></span><br><br>
					<canvas id="plHP2" width="240px" height="10px" style="border:1px solid black;border-radius:5px"></canvas>
				</div>
			</div>
		
			<div id="battlespace"></div>
			<script src="playersound.js"></script>
			<script src="player.js"></script>
		</div>
		<div>
			<span style="font-size:12px;margin-left:750px">FPS: <span id="FPS"></span></span><br>
			<div style="float:left;width:400px">
				<div style="padding-bottom:8px"><span style="font-weight:bold">Upload image: </span><input type="file" onchange="loadImage(this.files[0])"></div>
				<div style="padding-bottom:8px"><span style="font-weight:bold">Load from URL: </span><input id="textimgurl" type="text"><input type="button" value="Load" onclick="loadImgURL($('#textimgurl').val())"/></div>
				<img src="" id="imgpreview" height="200" alt="Image preview..."><br>
				<br>
			</div>
			<div style="float:left;width:400px">
				<span style="font-weight:bold">Load from text:</span><br>
				<textarea id="code" cols="40" rows="5"></textarea>
				<br>
				<input id="codeb" type="button" value="Load" onClick="loadCode()" />
				<input type="button" value="Paste Sample Code 1" onclick="$('#code').val(APIsample);"/>
				<input type="button" value="Paste Sample Code 2" onclick="$('#code').val(APIsample2);"/>
				<br><span id="error" style="color:red;width:100px"></span>
			</div>
			
		</div>
		<br style="clear:both"><br>
		<div>
			<input type="button" value="Show Fleet Details" onclick="loadFleetInfo(API)"/>
			<input id="radJP" type="radio" name="lang" onclick="translateTable()" /><label for="radJP">JP</label>
			<input id="radEN" type="radio" name="lang" onclick="translateTable()" checked="checked" /><label for="radEN">EN</label>
			<div id="fleetinfospace">
				<div id="friendfleetspace"></div><br><br>
				<div id="enemyfleetspace"></div>
			</div>
		</div>
		<script type="text/javascript">
			function makeTable(root,name,num) {
				if (!num) num = 6;
				var table = $('<table id="T'+name+'" class="infotable"></table>');
				var tr = $('<tr></tr>');
				for (var i=0; i<num; i++) tr.append($('<td colspan="4" id="name'+name+i+'"></td>'));
				table.append(tr);
				tr = $('<tr></tr>');
				for (var i=0; i<num; i++) tr.append($('<td colspan="4" style="text-align:center"><img id="img'+name+i+'"/></td>'));
				table.append(tr);
				tr = $('<tr></tr>');
				for (var i=0; i<num; i++) tr.append($('<td colspan="2"><img src="assets/stats/lv.png"/> <span id="lvl'+name+i+'"></span></td><td colspan="2"><img src="assets/stats/hp.png"/> <span id="hp'+name+i+'"></span></td>'));
				table.append(tr);
				tr = $('<tr></tr>');
				for (var i=0; i<num; i++) tr.append($('<td><img src="assets/stats/fp.png"/> <span id="fp'+name+i+'"></span></td><td><img src="assets/stats/tp.png"/> <span id="tp'+name+i+'"></span></td><td><img src="assets/stats/aa.png"/> <span id="aa'+name+i+'"></span></td><td><img src="assets/stats/ar.png"/> <span id="ar'+name+i+'"></span></td>'));
				table.append(tr);
				for (var j=0; j<4; j++) {
					tr = $('<tr></tr>');
					for (var i=0; i<num; i++) tr.append($('<td colspan="4"><span id="eq'+j+name+i+'"></span></td>'));
					table.append(tr);
				}
				$('#'+root).append(table);
				$('#'+root).append($('<br>'));
			}
			function loadFleetInfo(API) {
				if (!started) return;
				$('#friendfleetspace').html('');
				$('#enemyfleetspace').html('');
				makeTable('friendfleetspace','1');
				var fleet = API['fleet'+API.fleetnum];
				for (var i=0; i<fleet.length; i++) {
					var b = API.battles[0].data;
					if ($('#radJP').prop('checked')) $('#name1'+i).text(fleet[i].mst_id+'. '+SHIPDATA[fleet[i].mst_id].nameJP);
					else $('#name1'+i).text(fleet[i].mst_id+'. '+SHIPDATA[fleet[i].mst_id].name);
					$('#img1'+i).attr('src','assets/icons/'+SHIPDATA[fleet[i].mst_id].image);
					$('#lvl1'+i).text(fleet[i].level); $('#hp1'+i).text(b.api_maxhps[i+1]); 
					$('#fp1'+i).text(b.api_fParam[i][0]);$('#tp1'+i).text(b.api_fParam[i][1]);$('#aa1'+i).text(b.api_fParam[i][2]);$('#ar1'+i).text(b.api_fParam[i][3]);
					for (var j=0; j<4; j++) {
						if (!fleet[i].equip[j]) continue;
						if (EQDATA[fleet[i].equip[j]]) $('#eq'+j+'1'+i).text(EQDATA[fleet[i].equip[j]][$('#radJP').prop('checked')?'nameJP':'name']);
						else $('#eq'+j+'1'+i).text(fleet[i].equip[j]);
						$('#eq'+j+'1'+i).attr('title',fleet[i].equip[j]);
					}
				}
				for (var k=0; k<API.battles.length; k++) {
					var b = API.battles[k].data;
					if (!b.api_ship_ke) b = API.battles[k].yasen;
					makeTable('enemyfleetspace','2'+k);
					for (var i=0; i<b.api_ship_ke.length; i++) {
						var mid = b.api_ship_ke[i];
						if (mid <= 0) continue;
						if ($('#radJP').prop('checked')) $('#name2'+k+i).text(mid+'. '+SHIPDATA[mid].nameJP);
						else $('#name2'+k+i).text(mid+'. '+SHIPDATA[mid].name);
						$('#img2'+k+i).attr('src','assets/icons/'+SHIPDATA[mid].image);
						$('#lvl2'+k+i).text(b.api_ship_lv[i+1]); $('#hp2'+k+i).text(b.api_maxhps[i+7]); 
						$('#fp2'+k+i).text(b.api_eParam[i][0]);$('#tp2'+k+i).text(b.api_eParam[i][1]);$('#aa2'+k+i).text(b.api_eParam[i][2]);$('#ar2'+k+i).text(b.api_eParam[i][3]);
						for (var j=0; j<4; j++) {
							if (b.api_eSlot[i][j] <= 0) continue;
							if (EQDATA[b.api_eSlot[i][j]]) $('#eq'+j+'2'+k+i).text(EQDATA[b.api_eSlot[i][j]][$('#radJP').prop('checked')?'nameJP':'name']);
							else $('#eq'+j+'2'+k+i).text(b.api_eSlot[i][j]);
							$('#eq'+j+'2'+k+i).attr('title',b.api_eSlot[i][j]);
						}
					}
				}
			}
			function translateTable() {
				if (!started) return;
				var fleet = API['fleet'+API.fleetnum];
				for (var i=0; i<fleet.length; i++) {
					if ($('#radJP').prop('checked')) $('#name1'+i).text(fleet[i].mst_id+'. '+SHIPDATA[fleet[i].mst_id].nameJP);
					else $('#name1'+i).text(fleet[i].mst_id+'. '+SHIPDATA[fleet[i].mst_id].name);
					for (var j=0; j<4; j++) {
						if (!fleet[i].equip[j]) continue;
						if (EQDATA[fleet[i].equip[j]]) $('#eq'+j+'1'+i).text(EQDATA[fleet[i].equip[j]][$('#radJP').prop('checked')?'nameJP':'name']);
						else $('#eq'+j+'1'+i).text(fleet[i].equip[j]);
						$('#eq'+j+'1'+i).attr('title',fleet[i].equip[j]);
					}
				}
				for (var k=0; k<API.battles.length; k++) {
					var b = API.battles[k].data;
					if (!b.api_ship_ke) b = API.battles[k].yasen;
					for (var i=0; i<b.api_ship_ke.length; i++) {
						var mid = b.api_ship_ke[i];
						if (mid <= 0) continue;
						if ($('#radJP').prop('checked')) $('#name2'+k+i).text(mid+'. '+SHIPDATA[mid].nameJP);
						else $('#name2'+k+i).text(mid+'. '+SHIPDATA[mid].name);
						for (var j=0; j<4; j++) {
							if (b.api_eSlot[i][j] <= 0) continue;
							if (EQDATA[b.api_eSlot[i][j]]) $('#eq'+j+'2'+k+i).text(EQDATA[b.api_eSlot[i][j]][$('#radJP').prop('checked')?'nameJP':'name']);
							else $('#eq'+j+'2'+k+i).text(b.api_eSlot[i][j]);
							$('#eq'+j+'2'+k+i).attr('title',b.api_eSlot[i][j]);
						}
					}
				}
			}
		</script>
	</body>
</html>